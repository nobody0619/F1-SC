<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çºªè€å¸ˆ F1 SC ç²¾è‹±è®­ç»ƒç½‘</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:900px; margin:auto; text-align:center; }
    #login,#chapters,#quiz,#finish { margin:20px; }
    #chapters,#quiz,#finish { display:none; }

    .floating-back { position: sticky; top:10px; left:0; text-align:left; z-index:5; }
    .floating-back button{
      padding:10px 14px; border-radius:999px; border:0; background:#0aa; color:#fff; cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.12);
    }

    #chapters h2 { margin:10px 0 6px; }
    .group { text-align:left; margin:18px 0; }
    .group-title { font-weight:bold; font-size:18px; margin:8px 0; }
    .item {
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      border:1px solid #e6e6e6; border-radius:12px; padding:10px 14px; margin:8px 0; background:#fff;
    }
    .item .title { text-align:left; }
    .meta { color:#666; font-size:12px; margin-top:4px; }
    .go {
      padding:8px 12px; border-radius:10px; border:1px solid #333;
      background:#000; color:#fff; cursor:pointer;
    }

    #topbar { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
    #topbar .left { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    progress { width:100%; height:18px; }
    .question { text-align:left; margin:15px 0; padding-left:6px; }
    .option-label { display:block; margin:6px 0; cursor:pointer; }
    .feedback { font-weight:bold; margin:12px 0; }
    input[type="text"], input[type="password"] { width:100%; padding:10px; margin:6px 0; box-sizing:border-box; }
    input[type="radio"],input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
    img { max-width:100%; margin:10px 0; border:2px solid #ccc; }
    #submit-status { margin-top:10px; font-size:14px; }

    .card {
      max-width:520px; margin:0 auto; text-align:left;
      border:1px solid #e6e6e6; border-radius:16px; padding:16px 16px 10px; background:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
    }
    .row { margin:10px 0; }
    .row label { display:block; font-size:13px; color:#444; margin-bottom:6px; }
    .btn {
      width:100%; padding:10px 12px; border-radius:12px; border:0; background:#000; color:#fff; cursor:pointer;
      font-size:16px;
    }
    .small { font-size:12px; color:#666; line-height:1.4; }
    .pill {
      display:inline-block; padding:4px 10px; border-radius:999px; background:#f3f3f3; font-size:12px; color:#333;
      margin-left:8px;
    }
    .warn { color:#b00020; font-weight:bold; }
    .footer-contact { margin-top:16px; font-size:13px; color:#444; }
    .hint { margin-top:10px; color:#666; font-size:12px; }
  </style>
</head>
<body>

  <!-- ç™»å½•é¡µï¼šåå­— + å¯†ç ï¼ˆåå­—=IDï¼‰ -->
  <div id="login">
    <h2 id="loginTitle"></h2>
    <div class="card">
      <div class="row">
        <label>åå­— / Nameï¼ˆä¹Ÿæ˜¯ IDï¼‰</label>
        <input type="text" id="username" autocomplete="name"/>
      </div>
      <div class="row">
        <label>å¯†ç  / Password</label>
        <input type="password" id="password" autocomplete="current-password"/>
      </div>
      <button id="loginBtn" class="btn" type="button">ç™»å…¥å¹¶å¼€å§‹ / Login</button>

      <div class="row small" style="margin-top:12px;">
        <div>âœ… è‹¥ä½¿ç”¨ã€Œä¸‡ç”¨å¯†ç ã€ï¼Œç³»ç»Ÿå°†é™åˆ¶ç»ƒä¹ æ—¶é—´ï¼ˆ15 åˆ†é’Ÿï¼‰ã€‚</div>
        <div class="footer-contact">æœ‰é—®é¢˜å¯è”ç³»çºªè€å¸ˆï¼š<b>016-7312519</b></div>
        <div id="loginHint" class="hint"></div>
      </div>
    </div>
  </div>

  <div id="chapters">
    <div class="floating-back">
      <button type="button" id="logoutBtn">ğŸšª ç™»å‡º / Logout</button>
    </div>
    <h2>è¯·é€‰æ‹©ç« èŠ‚ / Select Chapter</h2>
    <div id="chapterWrap"></div>
  </div>

  <div id="quiz">
    <div class="floating-back">
      <button type="button" id="backToListTop">ğŸ  å›åˆ°ç« èŠ‚é€‰æ‹©</button>
    </div>
    <div id="topbar">
      <div class="left">
        <span id="quiz-title" style="font-weight:bold;"></span>
        <span id="authBadge" class="pill" style="display:none;"></span>
        <span id="countdownWrap" class="pill" style="display:none;">
          â³ <span id="countdown" class="warn">--:--</span>
        </span>
      </div>
      <div class="right">
        <span id="score">å¾—åˆ†: 0</span>
        <span id="remaining" style="margin-left:10px;">å‰©ä½™é¢˜ç›®: 0</span>
      </div>
    </div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="question-area"></div>
  </div>

  <div id="finish">
    <div class="floating-back">
      <button type="button" id="backFromFinish">ğŸ  å›åˆ°ç« èŠ‚é€‰æ‹©</button>
    </div>
    <h3 id="finish-msg"></h3>
    <p id="stats"></p>
    <p id="submit-status"></p>
    <p class="small">å¦‚é‡åˆ°æ— æ³•ç™»å…¥/é¢˜ç›®åŠ è½½å¤±è´¥/æˆç»©æœªä¸Šä¼ ï¼Œå¯è”ç³»çºªè€å¸ˆï¼š<b>016-7312519</b></p>
    <div id="controls"></div>
  </div>

  <!-- æˆç»©ä¸Šä¼ ï¼šéšè—è¡¨å•ï¼ˆè·¨åŸŸç¨³å®šï¼‰ -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm"
        action="https://script.google.com/macros/s/AKfycbwOadAK74XfAiOFkokD6zlQ8kQZTFDI0_SVWwMSSRgT8mwuoCac2VSAIj8X07L7NVVF/exec"
        method="post" target="postFrame" style="display:none;">
    <input name="book"/>
    <input name="quizId"/><input name="name"/><input name="score"/>
    <input name="correct"/><input name="wrong"/><input name="time"/>
    <input name="token"/>
  </form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /***********************
   * æ¯ä¸ª repo åªæ”¹è¿™é‡Œä¸€è¡Œï¼šBOOK
   ***********************/
  const BOOK = 'F1 SC';

  /***********************
   * ä½ çš„ Users Spreadsheetï¼ˆå°±æ˜¯ä½ ç»™çš„ sharing é“¾æ¥å¯¹åº”çš„ SS_IDï¼‰
   ***********************/
  const USERS_SS_ID = '1ZvbDaphklJAY109Hkxlf0xg0p3K-tclImoRADDKX2qc';

  // ä¸‡ç”¨å¯†ç æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  const UNIVERSAL_MINUTES = 15;

  // æˆç»©ä¸Šä¼ è„šæœ¬ï¼ˆPOSTï¼‰
  const SCRIPT_URL = document.getElementById('postForm').action;

  document.getElementById('loginTitle').textContent = document.title;

  let user = '';
  let rows = [];
  let chapterKey, labelKey, sheetKey;
  let groups = new Map();
  let currentRow = null;

  let qs = [], queue = [], score = 0, correct = 0, wrong = 0;
  let chapterStart = 0;
  const MAX_OPTS = 15;
  const countCache = new Map();

  const LS = {
    exp:  'auth_exp',
    role: 'auth_role',
    name: 'auth_name',
    book: 'auth_book',
    token:'auth_token'
  };

  function normalizeSid(v){
    return String(v || '').trim().replace(/\s+/g,' ').toLowerCase();
  }

  function toUsersSheetName(book){
    // F1 SC -> F1_SC_USERS
    // F4-ACC-Free -> F4_ACC_FREE_USERS
    // MM -> MM_USERS
    return book.toUpperCase()
      .replace(/[^A-Z0-9]+/g, '_')
      .replace(/^_+|_+$/g,'')
      + '_USERS';
  }

  function usersCsvUrl(book){
    const sheetName = toUsersSheetName(book);
    return `https://docs.google.com/spreadsheets/d/${USERS_SS_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  function parseExpireToMs(dateStr){
    // YYYY-MM-DD -> å½“æ—¥ 23:59:59.999
    const s = String(dateStr || '').trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return 0;
    const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
    return new Date(y, mo, d, 23, 59, 59, 999).getTime();
  }

  function todayStartMs(){
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0).getTime();
  }

  function showLogin(){
    document.getElementById('chapters').style.display = 'none';
    document.getElementById('quiz').style.display = 'none';
    document.getElementById('finish').style.display = 'none';
    document.getElementById('login').style.display = 'block';

    document.getElementById('loginHint').textContent =
      'å½“å‰ç”¨æˆ·è¡¨ï¼š' + toUsersSheetName(BOOK) + 'ï¼ˆè¯·ç¡®ä¿æ­¤å·¥ä½œè¡¨å­˜åœ¨ä¸”å·²å…¬å¼€å¯æŸ¥çœ‹ï¼‰';
  }

  function logout(){
    try{
      localStorage.removeItem(LS.exp);
      localStorage.removeItem(LS.role);
      localStorage.removeItem(LS.name);
      localStorage.removeItem(LS.book);
      localStorage.removeItem(LS.token);
    }catch(_){}
    showLogin();
  }

  document.getElementById('logoutBtn').onclick = logout;

  function loadUsers(book){
    const url = usersCsvUrl(book);
    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete(res){
          const data = (res.data || []).map(r => {
            const o = {};
            Object.entries(r).forEach(([k,v]) => o[String(k||'').trim()] = (v == null ? '' : String(v).trim()));
            resolve(data);
          });
        },
        error(err){
          reject(err || new Error('Failed to load users'));
        }
      });
    });
  }

  async function doLogin(){
    const nm = document.getElementById('username').value.trim();
    const pw = document.getElementById('password').value.trim();
    if (!nm) return alert('è¯·è¾“å…¥åå­— / Please enter your name');
    if (!pw) return alert('è¯·è¾“å…¥å¯†ç  / Password');

    const sidNorm = normalizeSid(nm);

    let users;
    try{
      users = await loadUsers(BOOK);
    }catch(e){
      return alert('ç™»å…¥å¤±è´¥ï¼šæ— æ³•è¯»å–ç”¨æˆ·è¡¨ï¼ˆè¯·ç¡®è®¤ Share å·²è®¾ä¸º Anyone with link å¯æŸ¥çœ‹ï¼‰');
    }

    const row = users.find(r => normalizeSid(r.sid || r.SID || r.Sid || '') === sidNorm);
    if (!row) return alert('ç™»å…¥å¤±è´¥ï¼šæ‰¾ä¸åˆ°è¯¥åå­—/ID');

    const realPw = String(row.password || row.Password || '').trim();
    if (pw !== realPw) return alert('ç™»å…¥å¤±è´¥ï¼šå¯†ç é”™è¯¯');

    const role = String(row.role || row.Role || 'user').trim().toLowerCase();
    const expireMs = parseExpireToMs(row.expire || row.Expire || row.expiry || row.Expiry || '');

    if (expireMs && expireMs < todayStartMs()) {
      return alert('ç™»å…¥å¤±è´¥ï¼šè´¦å·å·²è¿‡æœŸï¼ˆexpireï¼‰');
    }

    const sessionExp = (role === 'universal')
      ? (Date.now() + UNIVERSAL_MINUTES * 60 * 1000)
      : (expireMs || (Date.now() + 7*24*60*60*1000)); // æ²¡å†™ expire ç»™ 7 å¤©å…œåº•

    try{
      localStorage.setItem(LS.exp, String(sessionExp));
      localStorage.setItem(LS.role, role || 'user');
      localStorage.setItem(LS.name, nm);
      localStorage.setItem(LS.book, BOOK);
      localStorage.setItem(LS.token, 'csv-auth'); // ç»™æˆç»©ä¸Šä¼ ç”¨ï¼ˆå ä½ï¼‰
    }catch(_){}

    user = nm;
    await loadChapters();
    showChapterList();
  }

  document.getElementById('loginBtn').onclick = () => {
    doLogin().catch(e => alert('ç™»å…¥å¤±è´¥ï¼š' + (e && e.message ? e.message : String(e))));
  };

  async function verifyExistingSession(){
    let exp = 0, book = '', nm = '';
    try{
      exp = Number(localStorage.getItem(LS.exp) || 0);
      book = localStorage.getItem(LS.book) || '';
      nm = localStorage.getItem(LS.name) || '';
    }catch(_){ return false; }

    if (!exp || Date.now() > exp) return false;
    if (book !== BOOK) return false;

    user = nm;
    return !!user;
  }

  let countdownTimer = null;
  function updateAuthUI(){
    let role = '';
    let exp = 0;
    try{
      role = (localStorage.getItem(LS.role) || '').toLowerCase();
      exp = Number(localStorage.getItem(LS.exp) || 0);
    }catch(_){}

    const badge = document.getElementById('authBadge');
    const cdWrap = document.getElementById('countdownWrap');

    if (!role) {
      badge.style.display = 'none';
      cdWrap.style.display = 'none';
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;
      return;
    }

    badge.style.display = 'inline-block';
    badge.textContent = role === 'universal' ? 'ä¸‡ç”¨æ¨¡å¼' : (role === 'admin' ? 'è€å¸ˆ/ç®¡ç†å‘˜' : 'å·²ç™»å…¥');

    if (role !== 'universal') {
      cdWrap.style.display = 'none';
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;
      return;
    }

    cdWrap.style.display = 'inline-block';
    const el = document.getElementById('countdown');
    if (countdownTimer) clearInterval(countdownTimer);

    countdownTimer = setInterval(() => {
      const left = exp - Date.now();
      if (left <= 0) {
        clearInterval(countdownTimer);
        countdownTimer = null;
        el.textContent = '00:00';
        alert('ä¸‡ç”¨å¯†ç æ—¶é—´åˆ°ï¼Œè¯·é‡æ–°ç™»å…¥ã€‚');
        logout();
        return;
      }
      const totalSec = Math.floor(left / 1000);
      const mm = String(Math.floor(totalSec / 60)).padStart(2, '0');
      const ss = String(totalSec % 60).padStart(2, '0');
      el.textContent = mm + ':' + ss;
    }, 250);
  }

  document.getElementById('backToListTop').onclick = showChapterList;
  document.getElementById('backFromFinish').onclick = () => {
    document.getElementById('finish').style.display = 'none';
    showChapterList();
  };

  function loadChapters() {
    return new Promise((resolve) => {
      Papa.parse('Chapters.csv', {
        download:true, header:true, skipEmptyLines:true,
        complete(res) {
          rows = (res.data || []).map(raw => {
            const r={}; Object.entries(raw).forEach(([k,v])=>r[k.trim()]=v?.toString()?.trim() ?? v);
            return r;
          });
          if (!rows.length) { alert('è¯·æ£€æŸ¥ Chapters.csv'); return resolve(); }

          const keys = Object.keys(rows[0]);
          chapterKey = keys.find(k=>k.toLowerCase()==='chapter');
          labelKey   = keys.find(k=>k.toLowerCase()==='label');
          sheetKey   = keys.find(k=>k.toLowerCase()==='sheet');
          if (!chapterKey || !labelKey || !sheetKey) {
            alert('Chapters.csv éœ€è¦åˆ—: chapter, label, sheet');
            return resolve();
          }

          buildGroupsByCsvOrder(rows);
          resolve();
        }
      });
    });
  }

  function getMainChapterNo(chapterStr){
    if (!chapterStr) return null;
    const m = String(chapterStr).match(/(?:^|\s)(?:Chp|Bab)\s*([0-9]+)/i);
    return m ? parseInt(m[1],10) : null;
  }

  function buildGroupsByCsvOrder(list){
    const OTHERS = 'OTHERS';
    const map = new Map();
    const order = [];

    for (const r of list){
      const no = getMainChapterNo(r[chapterKey]);
      const key = (no === null ? OTHERS : no);
      if (!map.has(key)) {
        map.set(key, []);
        if (key !== OTHERS) order.push(key);
      }
      map.get(key).push(r);
    }

    const ordered = new Map();
    for (const k of order) ordered.set(k, map.get(k));
    if (map.has(OTHERS)) ordered.set(OTHERS, map.get(OTHERS));
    groups = ordered;
  }

  function showChapterList(){
    updateAuthUI();

    document.getElementById('quiz').style.display = 'none';
    document.getElementById('finish').style.display = 'none';

    const wrap = document.getElementById('chapterWrap');
    wrap.innerHTML = '';

    groups.forEach((arr, key) => {
      const g = document.createElement('div'); g.className = 'group';

      const title = document.createElement('div'); title.className = 'group-title';
      title.textContent = (key === 'OTHERS') ? 'å…¶ä»– Others' : ('Chp/Bab ' + key);
      g.appendChild(title);

      arr.forEach(row => {
        const item = document.createElement('div'); item.className = 'item';

        const left = document.createElement('div'); left.className = 'title';
        const t = document.createElement('div'); t.style.fontWeight = 'bold';
        t.textContent = row[chapterKey] + (row[labelKey] ? ' â€” ' + row[labelKey] : '');

        const meta = document.createElement('div'); meta.className = 'meta';
        meta.textContent = 'é¢˜æ•°ï¼šåŠ è½½ä¸­â€¦';
        left.appendChild(t); left.appendChild(meta);

        const go = document.createElement('button'); go.className = 'go'; go.textContent = 'å¼€å§‹';
        go.onclick = () => startQuiz(row);

        item.append(left, go); g.appendChild(item);

        const sheet = row[sheetKey];
        if (countCache.has(sheet)) {
          meta.textContent = 'é¢˜æ•°ï¼š' + countCache.get(sheet);
        } else {
          Papa.parse(sheet, {
            download:true, header:true, skipEmptyLines:true,
            complete(r2){
              const cnt = (r2.data || []).filter(q => q.question && String(q.question).trim()).length;
              countCache.set(sheet, cnt);
              meta.textContent = 'é¢˜æ•°ï¼š' + cnt;
            },
            error(){ meta.textContent = 'é¢˜æ•°ï¼šè·å–å¤±è´¥'; }
          });
        }
      });

      wrap.appendChild(g);
    });

    document.getElementById('login').style.display = 'none';
    document.getElementById('chapters').style.display = 'block';
  }

  function updateUI(delta){
    document.getElementById('score').textContent =
      'å¾—åˆ†: ' + score + (delta ? (' (' + (delta>0?'+':'') + delta + ')') : '');
    document.getElementById('remaining').textContent = 'å‰©ä½™é¢˜ç›®: ' + queue.length;
    const pg = document.getElementById('progress');
    pg.max = qs.length; pg.value = qs.length - queue.length;
  }

  function startQuiz(row){
    updateAuthUI();
    currentRow = row;

    document.getElementById('chapters').style.display = 'none';
    document.getElementById('quiz-title').textContent =
      row[chapterKey] + (row[labelKey] ? ' â€” ' + row[labelKey] : '');

    score = 0; correct = 0; wrong = 0;
    chapterStart = Date.now();

    Papa.parse(row[sheetKey], {
      download:true, header:true, skipEmptyLines:true,
      complete(res){
        qs = (res.data || []).map(q => Object.assign({}, q, { attempt: 0 }));
        queue = shuffle(qs.filter(q => q.question && String(q.question).trim()));
        document.getElementById('quiz').style.display = 'block';
        updateUI(0);
        nextQ();
      },
      error(){
        alert('è¿™ä¸ªç« èŠ‚çš„é¢˜ç›®åŠ è½½å¤±è´¥äº†ï¼Œè¯·æ£€æŸ¥è¡¨æ ¼é“¾æ¥ã€‚');
        showChapterList();
      }
    });
  }

  function nextQ(){
    let exp = 0;
    try{ exp = Number(localStorage.getItem(LS.exp) || 0); }catch(_){}
    if (!exp || Date.now() > exp) {
      alert('ç™»å…¥å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å…¥ã€‚');
      return logout();
    }

    const qa = document.getElementById('question-area');
    qa.innerHTML = '';
    updateUI(0);

    if (queue.length === 0) return finishQuiz();

    const q = queue.shift();
    const div = document.createElement('div'); div.className = 'question';
    div.innerHTML = '<p><strong>' + String(q.question||'').replace(/\r?\n/g,'<br/>') + '</strong></p>';

    if (q.image){
      const img = document.createElement('img');
      img.src = String(q.image).replace(/\s*\/\s*/g,'/').trim();
      div.appendChild(img);
    }

    const opts = document.createElement('div'); opts.className = 'options';

    if (q.type === 'text'){
      opts.innerHTML = '<input type="text" id="txtAns" placeholder="è¯·è¾“å…¥ç­”æ¡ˆâ€¦"/>';
    } else {
      const letters = [];
      for (let i=0;i<MAX_OPTS;i++) letters.push(String.fromCharCode(65+i));
      shuffle(letters.filter(l=>q[l])).forEach(l=>{
        const inp = document.createElement('input');
        inp.type = (q.type==='checkbox'?'checkbox':'radio');
        inp.name='opt'; inp.value=l; inp.id='opt_'+l;
        const lbl=document.createElement('label'); lbl.className='option-label'; lbl.htmlFor='opt_'+l;
        lbl.appendChild(inp); lbl.append(' ' + q[l]); opts.appendChild(lbl);
      });
    }

    div.appendChild(opts);

    const fb = document.createElement('div'); fb.className='feedback';
    div.appendChild(fb);

    const sb = document.createElement('button'); sb.textContent='æäº¤';
    sb.onclick = () => {
      let ua=[];
      if (q.type==='text'){
        ua = document.getElementById('txtAns').value.split(',').map(s=>s.trim()).filter(Boolean);
      } else {
        ua = Array.from(div.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
      }
      if (!ua.length) return alert('è¯·é€‰æ‹©æˆ–è¾“å…¥ç­”æ¡ˆ');

      let isC=false;
      if (q.type==='text'){
        const lows = ua.map(s=>s.toLowerCase());
        const ansList = String(q.answer||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
        isC = lows.some(v=>ansList.includes(v));
      } else if (q.type === 'checkbox') {
        const uaA = ua.map(s=>s.toUpperCase()).sort().join(',');
        const caA = String(q.answer||'').split(',').map(s=>s.trim().toUpperCase()).filter(Boolean).sort().join(',');
        isC = uaA === caA;
      } else {
        const accept = String(q.answer||'').split(',').map(s=>s.trim().toUpperCase()).filter(Boolean);
        isC = ua.length === 1 && accept.includes(ua[0].toUpperCase());
      }

      const allAnsHtml = (function(){
        if (q.type === 'text') {
          return String(q.answer||'').split(',').map(s=>s.trim()).filter(Boolean)
            .map((s,i)=> (i+1) + '. ' + s).join('<br>');
        }
        return String(q.answer||'').split(',').map(s=>s.trim().toUpperCase()).filter(Boolean)
          .map(letter => q[letter] || letter).join('<br>');
      })();

      const delta = isC ? (q.attempt?1:2) : (q.attempt?-2:-1);
      score += delta;
      if (isC) correct++; else wrong++;

      const explainLine = q.explain ? '<br><span style="font-weight:normal">' + String(q.explain) + '</span>' : '';

      fb.innerHTML = isC
        ? ('æ­£ç¡®! +' + delta + '<br>æ­£ç¡®ç­”æ¡ˆï¼š<br>' + allAnsHtml + explainLine)
        : ('é”™è¯¯! ' + delta + '<br>æ­£ç¡®ç­”æ¡ˆï¼š<br>' + allAnsHtml + explainLine);

      updateUI(delta);
      sb.disabled = true;

      const nb = document.createElement('button'); nb.textContent = 'ä¸‹ä¸€é¢˜'; nb.onclick = nextQ;
      div.appendChild(nb);

      if (!isC){
        q.attempt++;
        for (let i=0;i<2;i++){
          queue.splice(Math.floor(Math.random()*(queue.length+1)),0,Object.assign({}, q));
        }
      }
    };

    div.appendChild(sb);
    qa.appendChild(div);
  }

  function finishQuiz(){
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='block';
    document.getElementById('finish-msg').textContent = 'æ­å–œ ' + user + 'ï¼Œä½ å­¦ä¼šè¿™ä¸ªç« èŠ‚äº†ï¼';
    document.getElementById('stats').textContent =
      'å¾—åˆ†: ' + score + 'ï¼Œç­”å¯¹ ' + correct + ' é¢˜ï¼Œç­”é”™ ' + wrong + ' é¢˜';

    const token = (function(){ try{return localStorage.getItem(LS.token)||'';}catch(_){return '';} })();
    const form = document.getElementById('postForm');

    form.book.value    = BOOK;
    form.quizId.value  = currentRow[chapterKey];
    form.name.value    = user;
    form.score.value   = score;
    form.correct.value = correct;
    form.wrong.value   = wrong;
    form.time.value    = Math.floor((Date.now()-chapterStart)/1000);
    form.token.value   = token;

    form.submit();

    document.getElementById('submit-status').textContent =
      'âœ… æˆç»©å·²æäº¤ï¼ˆè‹¥è€å¸ˆè¡¨æ ¼æ²¡è®°å½•ï¼Œè¯·è”ç³»çºªè€å¸ˆ 016-7312519ï¼‰';

    const ctrl=document.getElementById('controls'); ctrl.innerHTML='';
    const back=document.createElement('button');
    back.textContent='è¿”å›ç« èŠ‚é€‰æ‹©';
    back.onclick=()=>{ document.getElementById('finish').style.display='none'; showChapterList(); };
    ctrl.appendChild(back);
  }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      const t=a[i]; a[i]=a[j]; a[j]=t;
    }
    return a;
  }

  (async () => {
    const ok = await verifyExistingSession();
    if (!ok) return showLogin();
    await loadChapters();
    showChapterList();
  })();
});
</script>
</body>
</html>
