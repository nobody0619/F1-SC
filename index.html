<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>纪老师 F1 SC 精英训练网</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:780px; margin:auto; text-align:center; }
    #welcome,#menu,#quiz,#finish { margin:20px; }
    #menu,#quiz,#finish { display:none; }
    #menu h2 { margin-bottom:8px; }
    #menu .subjects { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:10px; }
    #menu .subjects button { padding:6px 10px; }
    #menu .chapters { text-align:left; margin-top:8px; }
    #menu .chapters .item { display:flex; align-items:center; justify-content:space-between; gap:10px; border:1px solid #ddd; border-radius:10px; padding:10px 12px; margin:8px 0; }
    #menu .chapters .meta { color:#666; font-size:12px; }
    #menu .chapters .go { padding:6px 10px; }

    #topbar { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    #topbar .left { display:flex; align-items:center; gap:8px; }
    #topbar button { padding:6px 10px; }

    .question { text-align:left; margin:15px 0; padding-left:6px; }
    .option-label { display:block; margin:6px 0; cursor:pointer; }
    .feedback { font-weight:bold; margin:12px 0; }
    progress { width:100%; height:18px; }
    input[type="text"] { width:100%; padding:6px; margin:6px 0; }
    input[type="radio"],input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
    img { max-width:100%; margin:10px 0; border:2px solid #ccc; }
  </style>
</head>
<body>

  <!-- 1. 欢迎 & 姓名输入 -->
  <div id="welcome">
    <h2>请输入姓名 / Enter Your Name</h2>
    <input type="text" id="username" placeholder="姓名 / Name"/>
    <button id="startBtn" type="button">开始测验 / Start Quiz</button>
  </div>

  <!-- 2. 选择科目 & 章节 -->
  <div id="menu">
    <h2>请选择科目 / Select Subject</h2>
    <div class="subjects" id="subject-bar"></div>
    <div class="chapters" id="chapter-list"></div>
  </div>

  <!-- 3. 测验区域 -->
  <div id="quiz">
    <div id="topbar">
      <div class="left">
        <button id="backToChapters" type="button">← 返回章节</button>
        <span id="quiz-title" style="font-weight:bold;"></span>
      </div>
      <div class="right">
        <span id="score">得分: 0</span>
        <span id="remaining" style="margin-left:10px;">剩余题目: 0</span>
      </div>
    </div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="question-area"></div>
  </div>

  <!-- 4. 完成 -->
  <div id="finish">
    <h3 id="finish-msg"></h3>
    <p id="stats"></p>
    <div id="controls"></div>
  </div>

  <!-- 上传成绩（如不需要可移除） -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm"
        action="https://script.google.com/macros/s/AKfycbwOadAK74XfAiOFkokD6zlQ8kQZTFDI0_SVWwMSSRgT8mwuoCac2VSAIj8X07L7NVVF/exec"
        method="post" target="postFrame" style="display:none;">
    <input name="quizId"/><input name="name"/><input name="score"/>
    <input name="correct"/><input name="wrong"/><input name="time"/>
  </form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let user = '';
  let chapters = [];              // 原始 Chapters.csv 行
  let groupedBySubject = {};      // { subjectKey: [rows...] }
  let chapterKey, labelKey, sheetKey;

  let currentSubject = '';
  let currentChapterRow = null;

  // 测验状态
  let qs = [], queue = [], score = 0, correct = 0, wrong = 0;
  let chapterStart = 0;
  const MAX_OPTS = 15;

  // 题数缓存
  const countCache = new Map();   // sheetUrl -> number

  // 1) 绑定“开始”
  document.getElementById('startBtn').onclick = () => {
    const nm = document.getElementById('username').value.trim();
    if (!nm) return alert('请输入姓名');
    user = nm;
    document.getElementById('welcome').style.display = 'none';
    loadChapters();
  };

  // 顶部返回章节按钮
  document.getElementById('backToChapters').onclick = () => {
    // 回到章节列表（保留已选学科）
    document.getElementById('quiz').style.display = 'none';
    renderSubjectMenu();
    renderChapterList(currentSubject);
    document.getElementById('menu').style.display = 'block';
  };

  // 2) 加载 Chapters.csv（不再需要 Section）
  function loadChapters() {
    Papa.parse('Chapters.csv', {
      download: true, header: true, skipEmptyLines: true,
      complete(res) {
        chapters = res.data.map(raw => {
          const r = {};
          Object.entries(raw).forEach(([k,v]) => {
            r[k.trim()] = typeof v === 'string' ? v.trim() : v;
          });
          return r;
        });
        if (!chapters.length) return alert('请检查 Chapters.csv');

        const keys = Object.keys(chapters[0]);
        chapterKey = keys.find(k => k.toLowerCase() === 'chapter');
        labelKey   = keys.find(k => k.toLowerCase() === 'label');
        sheetKey   = keys.find(k => k.toLowerCase() === 'sheet');
        if (!chapterKey || !labelKey || !sheetKey) {
          return alert('Chapters.csv 需要列: chapter, label, sheet（已移除 section）');
        }

        // 按“科目”分组：默认取 Chapter 的前两个单词为科目（例如 "F1 SC", "F4 ACC"）
        groupedBySubject = {};
        for (const row of chapters) {
          const subject = getSubjectKey(row[chapterKey]);
          (groupedBySubject[subject] ||= []).push(row);
        }

        // 先按 Chapter 字符串排序，确保顺序自然
        Object.values(groupedBySubject).forEach(list => {
          list.sort((a,b) => a[chapterKey].localeCompare(b[chapterKey], 'zh-Hans'));
        });

        // 渲染科目列表
        renderSubjectMenu();
        document.getElementById('menu').style.display = 'block';
      }
    });
  }

  // 从 Chapter 字符串中提取“科目键”，如 "F1 SC Chp 1" -> "F1 SC"
  function getSubjectKey(chapterStr) {
    if (!chapterStr) return '其他';
    const parts = chapterStr.trim().split(/\s+/);
    if (parts.length >= 2) return parts[0] + ' ' + parts[1];
    return parts[0];
  }

  function renderSubjectMenu() {
    const bar = document.getElementById('subject-bar');
    bar.innerHTML = '';
    const subjects = Object.keys(groupedBySubject).sort((a,b)=>a.localeCompare(b,'zh-Hans'));
    subjects.forEach(sub => {
      const btn = document.createElement('button');
      btn.textContent = sub;
      btn.onclick = () => {
        currentSubject = sub;
        renderChapterList(sub);
      };
      bar.appendChild(btn);
    });

    // 若已有选中的学科，则自动展开
    if (currentSubject && groupedBySubject[currentSubject]) {
      renderChapterList(currentSubject);
    } else {
      document.getElementById('chapter-list').innerHTML = '';
    }
  }

  // 渲染某“科目”的章节列表，并显示题数
  function renderChapterList(subject) {
    const wrap = document.getElementById('chapter-list');
    wrap.innerHTML = '';
    const list = groupedBySubject[subject] || [];
    if (!list.length) {
      wrap.innerHTML = '<div class="meta">此科目暂无章节。</div>';
      return;
    }

    list.forEach(row => {
      const item = document.createElement('div');
      item.className = 'item';
      const left = document.createElement('div');
      const title = document.createElement('div');
      title.style.fontWeight = 'bold';
      title.textContent = row[chapterKey] + ' – ' + row[labelKey];

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = '题数：加载中…';
      left.appendChild(title);
      left.appendChild(meta);

      const go = document.createElement('button');
      go.className = 'go';
      go.textContent = '开始';
      go.onclick = () => startChapter(row);

      item.appendChild(left);
      item.appendChild(go);
      wrap.appendChild(item);

      // 异步统计题数（缓存）
      const sheet = row[sheetKey];
      if (countCache.has(sheet)) {
        meta.textContent = `题数：${countCache.get(sheet)}`;
      } else {
        Papa.parse(sheet, {
          download: true, header: true, skipEmptyLines: true,
          complete(r) {
            const count = r.data.filter(q => q.question && String(q.question).trim()).length;
            countCache.set(sheet, count);
            meta.textContent = `题数：${count}`;
          },
          error() {
            meta.textContent = '题数：获取失败';
          }
        });
      }
    });
  }

  // 3) 进入某章节
  function startChapter(row) {
    currentChapterRow = row;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('quiz-title').textContent =
      `${row[chapterKey]} – ${row[labelKey]}`;

    score = correct = wrong = 0;
    chapterStart = Date.now();

    Papa.parse(row[sheetKey], {
      download: true, header: true, skipEmptyLines: true,
      complete(r) {
        qs = r.data.map(q => ({...q, attempt: 0}));
        queue = shuffle(qs.filter(q => q.question && String(q.question).trim()));
        document.getElementById('quiz').style.display='block';
        document.getElementById('finish').style.display='none';
        updateUI(0);
        nextQ();
      }
    });
  }

  // 更新状态
  function updateUI(delta) {
    document.getElementById('score').textContent =
      `得分: ${score} ${delta ? '(' + (delta>0?'+':'') + delta + ')' : ''}`;
    document.getElementById('remaining').textContent =
      `剩余题目: ${queue.length}`;
    const pg = document.getElementById('progress');
    pg.max = qs.length; pg.value = qs.length - queue.length;
  }

  // 渲染题
  function nextQ() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; updateUI(0);
    if (queue.length === 0) return finishChapter();

    const q = queue.shift();
    const div = document.createElement('div');
    div.className = 'question';
    const safeQ = String(q.question || '').replace(/\r?\n/g,'<br/>');
    div.innerHTML = `<p><strong>${safeQ}</strong></p>`;

    if (q.image) {
      const src = String(q.image).replace(/\s*\//g,'/').trim();
      const img = document.createElement('img');
      img.src = src;
      div.appendChild(img);
    }

    const opts = document.createElement('div');
    opts.className = 'options';
    if (q.type === 'text') {
      opts.innerHTML = '<input type="text" id="txtAns" placeholder="请输入答案…"/>';
    } else {
      const letters = Array.from({length: MAX_OPTS}, (_,i)=>String.fromCharCode(65+i));
      // 只渲染存在的选项
      shuffle(letters.filter(l => q[l])).forEach(l => {
        const inp = document.createElement('input');
        inp.type = (q.type === 'checkbox' ? 'checkbox' : 'radio');
        inp.name = 'opt'; inp.value = l; inp.id = 'opt_'+l;
        const lbl = document.createElement('label');
        lbl.className = 'option-label'; lbl.htmlFor = 'opt_'+l;
        lbl.appendChild(inp);
        let raw = q[l];
        if (/^-?\d+\.0$/.test(raw)) raw = String(parseInt(raw));
        lbl.append(' ' + raw);
        opts.appendChild(lbl);
      });
    }
    div.appendChild(opts);

    const fb = document.createElement('div');
    fb.className = 'feedback'; div.appendChild(fb);

    const sb = document.createElement('button');
    sb.textContent = '提交';
    sb.onclick = () => {
      let ua = [];
      if (q.type === 'text') {
        ua = document.getElementById('txtAns').value
               .split(',').map(s=>s.trim()).filter(s=>s);
      } else {
        ua = Array.from(div.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
      }
      if (!ua.length) return alert('请选择或输入答案');

      let isC = false;
      if (q.type === 'text') {
        const lows = ua.map(s=>s.toLowerCase());
        const ansList = String(q.answer||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
        isC = lows.some(v => ansList.includes(v));
      } else {
        const uaA = ua.map(s=>s.toUpperCase()).sort().join(',');
        const caA = String(q.answer||'').split(',').map(s=>s.trim().toUpperCase()).filter(Boolean).sort().join(',');
        isC = uaA === caA;
      }

      const delta = isC ? (q.attempt ? 1 : 2) : (q.attempt ? -2 : -1);
      score += delta; if (isC) correct++; else wrong++;

      // 答错时逐行显示正确答案；不显示 A/B/C/D，只显示文本（支持英文/马来文用 / 分隔）
      let ansTxt = '';
      if (!isC) {
        if (q.type === 'text') {
          ansTxt = String(q.answer||'').split(',')
                    .map(s => s.trim()).filter(Boolean)
                    .map((s,i)=> `${i+1}. ${s}`)
                    .join('<br>');
        } else {
          ansTxt = String(q.answer||'').split(',')
                    .map(s => s.trim().toUpperCase()).filter(Boolean)
                    .map(letter => q[letter] || letter)
                    .join('<br>');
        }
      }
      fb.innerHTML = isC
        ? `正确! +${delta}`
        : `错误! ${delta}<br>正确答案：<br>${ansTxt}`;

      updateUI(delta);
      sb.disabled = true;
      const nb = document.createElement('button');
      nb.textContent = '下一题'; nb.onclick = nextQ;
      div.appendChild(nb);

      if (!isC) {
        q.attempt++;
        for (let i=0; i<2; i++) {
          queue.splice(Math.floor(Math.random()*(queue.length+1)), 0, {...q});
        }
      }
    };
    div.appendChild(sb);
    qa.appendChild(div);
  }

  // 完成本章节
  function finishChapter() {
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='block';
    document.getElementById('finish-msg').textContent =
      `恭喜 ${user}，你学会这个章节了！`;
    document.getElementById('stats').textContent =
      `得分: ${score}，答对 ${correct} 题，答错 ${wrong} 题`;

    // 上传成绩（如不需要可注释）
    const form = document.getElementById('postForm');
    form.quizId.value  = currentChapterRow[chapterKey];
    form.name.value    = user;
    form.score.value   = score;
    form.correct.value = correct;
    form.wrong.value   = wrong;
    form.time.value    = Math.floor((Date.now()-chapterStart)/1000);
    form.submit();

    const ctrl = document.getElementById('controls');
    ctrl.innerHTML = '';

    const back = document.createElement('button');
    back.textContent = '返回章节选择';
    back.onclick = () => {
      document.getElementById('finish').style.display = 'none';
      renderSubjectMenu();
      renderChapterList(currentSubject);
      document.getElementById('menu').style.display = 'block';
    };
    ctrl.appendChild(back);
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
});
</script>
</body>
</html>
