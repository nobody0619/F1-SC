<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çºªè€å¸ˆ F5 SC ç²¾è‹±è®­ç»ƒç½‘</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:900px; margin:auto; text-align:center; }
    #login,#chapters,#quiz,#finish { margin:20px; }
    #chapters,#quiz,#finish { display:none; }

    /* æ‚¬æµ®è¿”å›æŒ‰é’® */
    .floating-back { position: sticky; top:10px; left:0; text-align:left; z-index:5; }
    .floating-back button{
      padding:10px 14px; border-radius:999px; border:0; background:#0aa; color:#fff; cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.12);
    }

    /* ç« èŠ‚é¡µ */
    #chapters h2 { margin:10px 0 6px; }
    .group { text-align:left; margin:18px 0; }
    .group-title { font-weight:bold; font-size:18px; margin:8px 0; }
    .item {
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      border:1px solid #e6e6e6; border-radius:12px; padding:10px 14px; margin:8px 0; background:#fff;
    }
    .item .title { text-align:left; }
    .meta { color:#666; font-size:12px; margin-top:4px; }
    .go {
      padding:8px 12px; border-radius:10px; border:1px solid #333;
      background:#000; color:#fff; cursor:pointer;
    }

    /* æµ‹éªŒåŒº */
    #topbar { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
    #topbar .left { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    #topbar button { padding:6px 10px; }
    progress { width:100%; height:18px; }
    .question { text-align:left; margin:15px 0; padding-left:6px; }
    .option-label { display:block; margin:6px 0; cursor:pointer; }
    .feedback { font-weight:bold; margin:12px 0; }
    input[type="text"], input[type="password"] { width:100%; padding:10px; margin:6px 0; box-sizing:border-box; }
    input[type="radio"],input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
    img { max-width:100%; margin:10px 0; border:2px solid #ccc; }
    #submit-status { margin-top:10px; font-size:14px; }

    /* ç™»å½•å¡ç‰‡ */
    .card {
      max-width:520px; margin:0 auto; text-align:left;
      border:1px solid #e6e6e6; border-radius:16px; padding:16px 16px 10px; background:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
    }
    .row { margin:10px 0; }
    .row label { display:block; font-size:13px; color:#444; margin-bottom:6px; }
    .btn {
      width:100%; padding:10px 12px; border-radius:12px; border:0; background:#000; color:#fff; cursor:pointer;
      font-size:16px;
    }
    .small { font-size:12px; color:#666; line-height:1.4; }
    .pill {
      display:inline-block; padding:4px 10px; border-radius:999px; background:#f3f3f3; font-size:12px; color:#333;
      margin-left:8px;
    }
    .warn { color:#b00020; font-weight:bold; }
    .footer-contact { margin-top:16px; font-size:13px; color:#444; }
  </style>
</head>
<body>

  <!-- 1) ç™»å½•é¡µ -->
  <div id="login">
    <h2 id="loginTitle"></h2>
    <div class="card">
      <div class="row">
        <label>å§“å / Nameï¼ˆç”¨äºæˆç»©è®°å½•ï¼‰</label>
        <input type="text" id="username" placeholder="ä¾‹å¦‚ï¼šLim Amy / Kee..."/>
      </div>
      <div class="row">
        <label>ID / Sidï¼ˆä¸åˆ†å¤§å°å†™ï¼Œå¯åŒ…å«ç©ºæ ¼ï¼‰</label>
        <input type="text" id="sid" placeholder="ä¾‹å¦‚ï¼šS1110566 / Kee"/>
      </div>
      <div class="row">
        <label>å¯†ç  / Password</label>
        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç â€¦"/>
      </div>
      <button id="loginBtn" class="btn" type="button">ç™»å…¥å¹¶å¼€å§‹ / Login</button>

      <div class="row small" style="margin-top:12px;">
        <div>âœ… è‹¥ä½¿ç”¨ã€Œä¸‡ç”¨å¯†ç ã€ï¼Œç³»ç»Ÿå°†é™åˆ¶ç»ƒä¹ æ—¶é—´ï¼ˆé»˜è®¤ 15 åˆ†é’Ÿï¼‰ã€‚</div>
        <div class="footer-contact">æœ‰é—®é¢˜å¯è”ç³»çºªè€å¸ˆï¼š<b>016-7312519</b></div>
      </div>
    </div>
  </div>

  <!-- 2) ç« èŠ‚é¡µ -->
  <div id="chapters">
    <div class="floating-back">
      <button type="button" id="logoutBtn">ğŸšª ç™»å‡º / Logout</button>
    </div>
    <h2>è¯·é€‰æ‹©ç« èŠ‚ / Select Chapter</h2>
    <div id="chapterWrap"></div>
  </div>

  <!-- 3) æµ‹éªŒé¡µ -->
  <div id="quiz">
    <div class="floating-back">
      <button type="button" id="backToListTop">ğŸ  å›åˆ°ç« èŠ‚é€‰æ‹©</button>
    </div>
    <div id="topbar">
      <div class="left">
        <span id="quiz-title" style="font-weight:bold;"></span>
        <span id="authBadge" class="pill" style="display:none;"></span>
        <span id="countdownWrap" class="pill" style="display:none;">
          â³ <span id="countdown" class="warn">--:--</span>
        </span>
      </div>
      <div class="right">
        <span id="score">å¾—åˆ†: 0</span>
        <span id="remaining" style="margin-left:10px;">å‰©ä½™é¢˜ç›®: 0</span>
      </div>
    </div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="question-area"></div>
  </div>

  <!-- 4) å®Œæˆé¡µ -->
  <div id="finish">
    <div class="floating-back">
      <button type="button" id="backFromFinish">ğŸ  å›åˆ°ç« èŠ‚é€‰æ‹©</button>
    </div>
    <h3 id="finish-msg"></h3>
    <p id="stats"></p>
    <p id="submit-status"></p>
    <p class="small">å¦‚é‡åˆ°æ— æ³•ç™»å…¥/é¢˜ç›®åŠ è½½å¤±è´¥/æˆç»©æœªä¸Šä¼ ï¼Œå¯è”ç³»çºªè€å¸ˆï¼š<b>016-7312519</b></p>
    <div id="controls"></div>
  </div>

  <!-- æˆç»©ä¸Šä¼ ï¼šéšè—è¡¨å•ï¼ˆç”¨æ¥å…œåº•æäº¤ï¼‰ -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm"
        action="https://script.google.com/macros/s/AKfycbwOadAK74XfAiOFkokD6zlQ8kQZTFDI0_SVWwMSSRgT8mwuoCac2VSAIj8X07L7NVVF/exec"
        method="post" target="postFrame" style="display:none;">
    <input name="book"/>
    <input name="quizId"/><input name="name"/><input name="score"/>
    <input name="correct"/><input name="wrong"/><input name="time"/>
    <!-- é¢å¤–å¸¦ä¸Š tokenï¼ˆåå°ä¸éœ€è¦ä¹Ÿä¸å½±å“ï¼‰ -->
    <input name="token"/>
  </form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /***********************
   * ä½ åªéœ€è¦æ”¹è¿™é‡Œä¸€è¡Œï¼šBOOK
   * æ¯ä¸ª repo å¯¹åº”ä¸€ä¸ªç§‘ç›®ï¼š
   * ä¾‹ï¼šF1 SC / F2 SC / F3 SC / F4 SC / F5 SC / F4 ACC / F5 ACC / MM / F4-ACC-Free
   ***********************/
  const BOOK = 'F5 SC';  // <<< åªè¦æ”¹è¿™ä¸ªï¼ˆF1 SCã€F2 SC...ï¼‰

  // ä¸‡ç”¨å¯†ç å€’è®¡æ—¶ï¼ˆåˆ†é’Ÿï¼‰
  const UNIVERSAL_MINUTES = 15;

  // Apps Script WebApp URLï¼ˆæ²¿ç”¨ä½ åŸæœ¬ postForm çš„ actionï¼‰
  const SCRIPT_URL = document.getElementById('postForm').action;

  // ç™»å½•é¡µæ ‡é¢˜ = ç½‘é¡µ title
  document.getElementById('loginTitle').textContent = document.title;

  /***********************
   * çŠ¶æ€
   ***********************/
  let user = '';
  let rows = [];
  let chapterKey, labelKey, sheetKey;

  // åˆ†ç»„ï¼šChp/Bab å· -> rowsï¼›OTHERS æ”¾æœ€å
  let groups = new Map();
  let groupOrder = [];

  let currentRow = null;

  // æµ‹éªŒçŠ¶æ€
  let qs = [], queue = [], score = 0, correct = 0, wrong = 0;
  let chapterStart = 0;
  const MAX_OPTS = 15;

  const countCache = new Map(); // sheetUrl -> é¢˜æ•°ç¼“å­˜

  // auth
  const LS = {
    token: 'auth_token',
    exp: 'auth_exp',
    role: 'auth_role',
    sid: 'auth_sid',
    name: 'auth_name',
    book: 'auth_book'
  };

  /***********************
   * å°å·¥å…·ï¼šsid å½’ä¸€ï¼ˆä¸åˆ†å¤§å°å†™ + ç©ºæ ¼å¤„ç†ï¼‰
   ***********************/
  function normalizeSid(v){
    return String(v || '').trim().replace(/\s+/g,' ').toLowerCase();
  }

  function showLogin(){
    document.getElementById('chapters').style.display = 'none';
    document.getElementById('quiz').style.display = 'none';
    document.getElementById('finish').style.display = 'none';
    document.getElementById('login').style.display = 'block';
  }

  function showChapters(){
    document.getElementById('login').style.display = 'none';
    document.getElementById('chapters').style.display = 'block';
  }

  function logout(){
    localStorage.removeItem(LS.token);
    localStorage.removeItem(LS.exp);
    localStorage.removeItem(LS.role);
    localStorage.removeItem(LS.sid);
    localStorage.removeItem(LS.name);
    localStorage.removeItem(LS.book);
    showLogin();
  }

  document.getElementById('logoutBtn').onclick = logout;

  /***********************
   * ç™»å½•/éªŒè¯
   ***********************/
  async function apiPost(params){
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: new URLSearchParams(params)
    });
    const data = await res.json().catch(()=>null);
    if (!res.ok) throw new Error((data && data.error) ? data.error : (res.status + ' ' + res.statusText));
    return data;
  }

  async function doLogin(){
    const nm = document.getElementById('username').value.trim();
    if (!nm) return alert('è¯·è¾“å…¥å§“å / Please enter your name');

    const sidRaw = document.getElementById('sid').value;
    const pw = document.getElementById('password').value.trim();

    const sid = normalizeSid(sidRaw);
    if (!sid) return alert('è¯·è¾“å…¥ ID / Sid');
    if (!pw) return alert('è¯·è¾“å…¥å¯†ç  / Password');

    // è¯·æ±‚ Apps Script ç™»å½•
    const data = await apiPost({
      action: 'login',
      book: BOOK,
      sid: sid,           // å·²å½’ä¸€ï¼ˆå°å†™ï¼‰
      password: pw
    });

    if (!data || !data.ok) return alert((data && data.error) ? data.error : 'Login failed');

    // ä¿å­˜ auth
    localStorage.setItem(LS.token, data.token);
    localStorage.setItem(LS.exp, String(data.exp));
    localStorage.setItem(LS.role, String(data.role || 'user'));
    localStorage.setItem(LS.sid, sid);
    localStorage.setItem(LS.name, nm);
    localStorage.setItem(LS.book, BOOK);

    user = nm;

    // è¿›å…¥ç« èŠ‚
    await loadChapters();
    showChapterList();
  }

  document.getElementById('loginBtn').onclick = async () => {
    try { await doLogin(); }
    catch(e){ alert('ç™»å…¥å¤±è´¥ï¼š' + e.message); }
  };

  async function verifyExistingSession(){
    const token = localStorage.getItem(LS.token);
    const exp = Number(localStorage.getItem(LS.exp) || 0);
    const book = localStorage.getItem(LS.book);

    if (!token || !exp || Date.now() > exp) return false;
    if (book !== BOOK) return false;

    // å¯é€‰ï¼šåç«¯ verifyï¼ˆç¡®ä¿ä½ æ”¹äº† expiry åï¼Œæ—§ token ä¹Ÿä¼šå¤±æ•ˆï¼‰
    try{
      const v = await apiPost({ action:'verify', token });
      if (!v || !v.ok) return false;
      if (v.payload && v.payload.book && v.payload.book !== BOOK) return false;
    }catch(_){
      // verify å¤±è´¥å°±å½“æœªç™»å½•
      return false;
    }

    user = localStorage.getItem(LS.name) || '';
    return !!user;
  }

  /***********************
   * ä¸‡ç”¨å€’è®¡æ—¶æ˜¾ç¤º
   ***********************/
  let countdownTimer = null;

  function updateAuthUI(){
    const role = (localStorage.getItem(LS.role) || '').toLowerCase();
    const exp = Number(localStorage.getItem(LS.exp) || 0);

    const badge = document.getElementById('authBadge');
    const cdWrap = document.getElementById('countdownWrap');

    if (!role) {
      badge.style.display = 'none';
      cdWrap.style.display = 'none';
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;
      return;
    }

    badge.style.display = 'inline-block';
    badge.textContent = role === 'universal' ? 'ä¸‡ç”¨æ¨¡å¼' : (role === 'admin' ? 'è€å¸ˆ/ç®¡ç†å‘˜' : 'å·²ç™»å…¥');

    // åªæœ‰ universal æ‰æ˜¾ç¤ºå€’è®¡æ—¶
    if (role !== 'universal') {
      cdWrap.style.display = 'none';
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;
      return;
    }

    cdWrap.style.display = 'inline-block';

    const el = document.getElementById('countdown');
    if (countdownTimer) clearInterval(countdownTimer);

    countdownTimer = setInterval(() => {
      const left = exp - Date.now();
      if (left <= 0) {
        clearInterval(countdownTimer);
        countdownTimer = null;
        el.textContent = '00:00';
        alert('ä¸‡ç”¨å¯†ç æ—¶é—´åˆ°ï¼Œè¯·é‡æ–°ç™»å…¥ã€‚');
        logout();
        return;
      }
      const totalSec = Math.floor(left / 1000);
      const mm = String(Math.floor(totalSec / 60)).padStart(2, '0');
      const ss = String(totalSec % 60).padStart(2, '0');
      el.textContent = `${mm}:${ss}`;
    }, 250);
  }

  /***********************
   * ç« èŠ‚ / æµ‹éªŒï¼ˆä¿ç•™ä½ åŸæœ¬é€»è¾‘ï¼‰
   ***********************/
  document.getElementById('backToListTop').onclick = showChapterList;
  document.getElementById('backFromFinish').onclick = () => {
    document.getElementById('finish').style.display = 'none';
    showChapterList();
  };

  // è½½å…¥ Chapters.csv
  async function loadChapters() {
    return new Promise((resolve) => {
      Papa.parse('Chapters.csv', {
        download:true, header:true, skipEmptyLines:true,
        complete(res) {
          rows = res.data.map(raw => {
            const r={}; Object.entries(raw).forEach(([k,v])=>r[k.trim()]=v?.toString()?.trim() ?? v);
            return r;
          });
          if (!rows.length) { alert('è¯·æ£€æŸ¥ Chapters.csv'); return resolve(); }

          const keys = Object.keys(rows[0]);
          chapterKey = keys.find(k=>k.toLowerCase()==='chapter');
          labelKey   = keys.find(k=>k.toLowerCase()==='label');
          sheetKey   = keys.find(k=>k.toLowerCase()==='sheet');
          if (!chapterKey || !labelKey || !sheetKey) {
            alert('Chapters.csv éœ€è¦åˆ—: chapter, label, sheet');
            return resolve();
          }

          buildGroupsByCsvOrder(rows);
          resolve();
        }
      });
    });
  }

  // æå–ç¬¬ä¸€ä¸ª Chp/Bab çš„æ•°å­—ï¼ˆå…è®¸ 0ï¼‰ï¼Œå¦åˆ™è¿”å› null
  function getMainChapterNo(chapterStr){
    if (!chapterStr) return null;
    const m = String(chapterStr).match(/(?:^|\s)(?:Chp|Bab)\s*([0-9]+)/i);
    return m ? parseInt(m[1],10) : null;
  }

  // æŒ‰ CSV é¡ºåºå»ºç»„ï¼›æ— ç¼–å·ä¸º OTHERS
  function buildGroupsByCsvOrder(list){
    groups = new Map();
    groupOrder = [];
    const OTHERS = 'OTHERS';

    for (const r of list){
      const no = getMainChapterNo(r[chapterKey]);
      const key = (no === null ? OTHERS : no);

      if (!groups.has(key)) {
        groups.set(key, []);
        if (key !== OTHERS) groupOrder.push(key);
      }
      groups.get(key).push(r);
    }

    const ordered = new Map();
    for (const k of groupOrder) ordered.set(k, groups.get(k));
    if (groups.has(OTHERS)) ordered.set(OTHERS, groups.get(OTHERS));
    groups = ordered;
  }

  // æ¸²æŸ“ç« èŠ‚åˆ—è¡¨
  function showChapterList(){
    updateAuthUI();

    document.getElementById('quiz').style.display = 'none';
    document.getElementById('finish').style.display = 'none';

    const wrap = document.getElementById('chapterWrap');
    wrap.innerHTML = '';

    groups.forEach((arr, key) => {
      const g = document.createElement('div'); g.className = 'group';

      const title = document.createElement('div'); title.className = 'group-title';
      title.textContent = (key === 'OTHERS') ? 'å…¶ä»– Others' : `Chp/Bab ${key}`;
      g.appendChild(title);

      arr.forEach(row => {
        const item = document.createElement('div'); item.className = 'item';

        const left = document.createElement('div'); left.className = 'title';
        const t = document.createElement('div'); t.style.fontWeight = 'bold';
        t.textContent = `${row[chapterKey]} ${row[labelKey] ? 'â€” ' + row[labelKey] : ''}`;

        const meta = document.createElement('div'); meta.className = 'meta';
        meta.textContent = 'é¢˜æ•°ï¼šåŠ è½½ä¸­â€¦';
        left.appendChild(t); left.appendChild(meta);

        const go = document.createElement('button'); go.className = 'go'; go.textContent = 'å¼€å§‹';
        go.onclick = () => startQuiz(row);

        item.append(left, go); g.appendChild(item);

        const sheet = row[sheetKey];
        if (countCache.has(sheet)) {
          meta.textContent = `é¢˜æ•°ï¼š${countCache.get(sheet)}`;
        } else {
          Papa.parse(sheet, {
            download:true, header:true, skipEmptyLines:true,
            complete(r2){
              const cnt = r2.data.filter(q => q.question && String(q.question).trim()).length;
              countCache.set(sheet, cnt);
              meta.textContent = `é¢˜æ•°ï¼š${cnt}`;
            },
            error(){ meta.textContent = 'é¢˜æ•°ï¼šè·å–å¤±è´¥'; }
          });
        }
      });

      wrap.appendChild(g);
    });

    document.getElementById('login').style.display = 'none';
    document.getElementById('chapters').style.display = 'block';
  }

  // è¿›å…¥æŸä¸€ç« å¼€å§‹æµ‹éªŒ
  function startQuiz(row){
    updateAuthUI();

    currentRow = row;
    document.getElementById('chapters').style.display = 'none';
    document.getElementById('quiz-title').textContent =
      `${row[chapterKey]}${row[labelKey] ? ' â€” ' + row[labelKey] : ''}`;

    score = correct = wrong = 0;
    chapterStart = Date.now();

    Papa.parse(row[sheetKey], {
      download:true, header:true, skipEmptyLines:true,
      complete(res){
        qs = res.data.map(q => ({...q, attempt:0}));
        queue = shuffle(qs.filter(q => q.question && String(q.question).trim()));
        document.getElementById('quiz').style.display = 'block';
        updateUI(0);
        nextQ();
      },
      error(){
        alert('è¿™ä¸ªç« èŠ‚çš„é¢˜ç›®åŠ è½½å¤±è´¥äº†ï¼Œè¯·æ£€æŸ¥è¡¨æ ¼é“¾æ¥ã€‚');
        showChapterList();
      }
    });
  }

  // æ›´æ–°é¡¶éƒ¨ UI
  function updateUI(delta){
    document.getElementById('score').textContent =
      `å¾—åˆ†: ${score} ${delta ? '(' + (delta>0?'+':'') + delta + ')' : ''}`;
    document.getElementById('remaining').textContent = `å‰©ä½™é¢˜ç›®: ${queue.length}`;
    const pg = document.getElementById('progress');
    pg.max = qs.length; pg.value = qs.length - queue.length;
  }

  // å‡ºä¸‹ä¸€é¢˜
  function nextQ(){
    // è¿‡æœŸä¿æŠ¤ï¼ˆå‰ç«¯æœ¬åœ° expï¼‰
    const exp = Number(localStorage.getItem(LS.exp) || 0);
    if (!exp || Date.now() > exp) {
      alert('ç™»å…¥å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å…¥ã€‚');
      return logout();
    }

    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; updateUI(0);
    if (queue.length === 0) return finishQuiz();

    const q = queue.shift();
    const div = document.createElement('div'); div.className = 'question';
    div.innerHTML = `<p><strong>${(q.question||'').replace(/\r?\n/g,'<br/>')}</strong></p>`;

    if (q.image){
      const img = document.createElement('img');
      img.src = String(q.image).replace(/\s*\//g,'/').trim();
      div.appendChild(img);
    }

    const opts = document.createElement('div'); opts.className = 'options';
    if (q.type === 'text'){
      opts.innerHTML = '<input type="text" id="txtAns" placeholder="è¯·è¾“å…¥ç­”æ¡ˆâ€¦"/>';
    } else {
      const letters = Array.from({length:MAX_OPTS}, (_,i)=>String.fromCharCode(65+i));
      shuffle(letters.filter(l=>q[l])).forEach(l=>{
        const inp = document.createElement('input');
        inp.type = (q.type==='checkbox'?'checkbox':'radio');
        inp.name='opt'; inp.value=l; inp.id='opt_'+l;
        const lbl=document.createElement('label'); lbl.className='option-label'; lbl.htmlFor='opt_'+l;
        lbl.appendChild(inp); lbl.append(' '+q[l]); opts.appendChild(lbl);
      });
    }
    div.appendChild(opts);

    const fb = document.createElement('div'); fb.className='feedback'; div.appendChild(fb);

    const sb = document.createElement('button'); sb.textContent='æäº¤';
    sb.onclick = () => {
      // 1) æ”¶é›†ä½œç­”
      let ua=[];
      if (q.type==='text'){
        ua = document.getElementById('txtAns').value
               .split(',')
               .map(s=>s.trim())
               .filter(Boolean);
      } else {
        ua = Array.from(div.querySelectorAll('input[name="opt"]:checked'))
               .map(i=>i.value);
      }
      if (!ua.length) return alert('è¯·é€‰æ‹©æˆ–è¾“å…¥ç­”æ¡ˆ');

      // 2) åˆ¤åˆ†é€»è¾‘
      let isC=false;
      if (q.type==='text'){
        const lows = ua.map(s=>s.toLowerCase());
        const ansList = String(q.answer||'')
                          .split(',')
                          .map(s=>s.trim().toLowerCase())
                          .filter(Boolean);
        isC = lows.some(v=>ansList.includes(v));

      } else if (q.type === 'checkbox') {
        const uaA = ua.map(s=>s.toUpperCase()).sort().join(',');
        const caA = String(q.answer||'')
                      .split(',')
                      .map(s=>s.trim().toUpperCase())
                      .filter(Boolean)
                      .sort()
                      .join(',');
        isC = uaA === caA;

      } else { // radioï¼šå…è®¸å¤šä¸ªæ­£ç¡®ç­”æ¡ˆï¼Œä»»ä¸€å‘½ä¸­å³å¯
        const accept = String(q.answer||'')
                         .split(',')
                         .map(s=>s.trim().toUpperCase())
                         .filter(Boolean);
        isC = ua.length === 1 && accept.includes(ua[0].toUpperCase());
      }

      // ç»Ÿä¸€ç”Ÿæˆæ­£ç¡®ç­”æ¡ˆ HTMLï¼ˆé€è¡Œï¼Œä¸æ˜¾ç¤º A/B/C/Dï¼‰
      const allAnsHtml = (() => {
        if (q.type === 'text') {
          return String(q.answer||'')
                   .split(',')
                   .map(s=>s.trim())
                   .filter(Boolean)
                   .map((s,i)=>`${i+1}. ${s}`)
                   .join('<br>');
        }
        return String(q.answer||'')
                 .split(',')
                 .map(s=>s.trim().toUpperCase())
                 .filter(Boolean)
                 .map(letter => q[letter] || letter)
                 .join('<br>');
      })();

      // 3) è®¡åˆ†
      const delta = isC ? (q.attempt?1:2) : (q.attempt?-2:-1);
      score += delta; if (isC) correct++; else wrong++;

      const explainLine = q.explain
        ? `<br><span style="font-weight:normal">${String(q.explain)}</span>` : '';

      // 4) åé¦ˆï¼šç­”å¯¹ / ç­”é”™éƒ½æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
      fb.innerHTML = isC
        ? `æ­£ç¡®! +${delta}<br>æ­£ç¡®ç­”æ¡ˆï¼š<br>${allAnsHtml}${explainLine}`
        : `é”™è¯¯! ${delta}<br>æ­£ç¡®ç­”æ¡ˆï¼š<br>${allAnsHtml}${explainLine}`;

      updateUI(delta);
      sb.disabled = true;
      const nb = document.createElement('button'); nb.textContent = 'ä¸‹ä¸€é¢˜'; nb.onclick = nextQ;
      div.appendChild(nb);

      // 5) é”™é¢˜å›æ¨
      if (!isC){
        q.attempt++;
        for (let i=0;i<2;i++){
          queue.splice(Math.floor(Math.random()*(queue.length+1)),0,{...q});
        }
      }
    };
    div.appendChild(sb);

    document.getElementById('question-area').appendChild(div);
  }

  // äº¤å· & ä¸Šä¼ æˆç»©ï¼ˆä¿ç•™ä½ åŸæœ¬ fetch + form å…œåº•ï¼‰
  async function finishQuiz(){
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='block';
    document.getElementById('finish-msg').textContent = `æ­å–œ ${user}ï¼Œä½ å­¦ä¼šè¿™ä¸ªç« èŠ‚äº†ï¼`;
    document.getElementById('stats').textContent =
      `å¾—åˆ†: ${score}ï¼Œç­”å¯¹ ${correct} é¢˜ï¼Œç­”é”™ ${wrong} é¢˜`;
    document.getElementById('submit-status').textContent = 'æ­£åœ¨ä¸Šä¼ æˆç»©â€¦';

    const token = localStorage.getItem(LS.token) || '';

    const payload = {
      book: BOOK,                         // âœ… ç°åœ¨ä»¥ BOOK ä¸ºå‡†
      quizId: currentRow[chapterKey],
      name: user,
      score: score,
      correct: correct,
      wrong: wrong,
      time: Math.floor((Date.now()-chapterStart)/1000),
      token: token
    };

    try {
      // 1) å…ˆç”¨ fetch æ­£å¼å‘ä¸€æ¬¡
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: new URLSearchParams(payload)
      });
      if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
      document.getElementById('submit-status').textContent = 'âœ… æˆç»©å·²ä¸Šä¼ ';
    } catch (e) {
      // 2) å¤±è´¥æ—¶ç”¨éšè— form å…œåº•æäº¤ä¸€æ¬¡
      const form = document.getElementById('postForm');
      form.book.value    = payload.book;
      form.quizId.value  = payload.quizId;
      form.name.value    = payload.name;
      form.score.value   = payload.score;
      form.correct.value = payload.correct;
      form.wrong.value   = payload.wrong;
      form.time.value    = payload.time;
      form.token.value   = payload.token;
      form.submit();
      document.getElementById('submit-status').textContent =
        'âš ï¸ æˆç»©å¯èƒ½æ²¡æœ‰ä¸Šä¼ æˆåŠŸï¼Œè¯·è€å¸ˆæ£€æŸ¥è¡¨æ ¼é“¾æ¥/æƒé™';
      console.error('Score upload failed:', e);
    }

    const ctrl=document.getElementById('controls'); ctrl.innerHTML='';
    const back=document.createElement('button');
    back.textContent='è¿”å›ç« èŠ‚é€‰æ‹©';
    back.onclick=()=>{ document.getElementById('finish').style.display='none'; showChapterList(); };
    ctrl.appendChild(back);
  }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  /***********************
   * å¯åŠ¨ï¼šå…ˆéªŒè¯æ˜¯å¦å·²ç™»å½•
   ***********************/
  (async () => {
    const ok = await verifyExistingSession();
    if (!ok) return showLogin();

    // å·²ç™»å½•åˆ™ç›´æ¥è¿›ç« èŠ‚
    await loadChapters();
    showChapterList();
  })();
});
</script>
</body>
</html>
